

<!DOCTYPE html>
<html lang="zh-CN" >



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="dingrui">
  <meta name="keywords" content="">
  
    <meta name="description" content="1 不使用KQueue12345678910111213141516171819202122232425262728293031323334353637383940414243#include &lt;iostream&gt;#include &lt;sys&#x2F;socket.h&gt;#include &lt;sys&#x2F;types.h&gt;#include &lt;netinet&#x2F;in.h&gt;#">
<meta property="og:type" content="article">
<meta property="og:title" content="KQueue">
<meta property="og:url" content="https://bannirui.github.io/2023/03/11/KQueue/index.html">
<meta property="og:site_name" content="HEX BLOG">
<meta property="og:description" content="1 不使用KQueue12345678910111213141516171819202122232425262728293031323334353637383940414243#include &lt;iostream&gt;#include &lt;sys&#x2F;socket.h&gt;#include &lt;sys&#x2F;types.h&gt;#include &lt;netinet&#x2F;in.h&gt;#">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-03-11T06:23:11.000Z">
<meta property="article:modified_time" content="2025-01-24T15:52:43.309Z">
<meta property="article:author" content="dingrui">
<meta property="article:tag" content="KQueue">
<meta name="twitter:card" content="summary_large_image">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>KQueue - HEX BLOG</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  



  
<link rel="stylesheet" href="/css/iconfont_gmail/iconfont.css">
<link rel="stylesheet" href="/css/iconfont_outlook/iconfont.css">
<link rel="stylesheet" href="/css/my-collapse.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"bannirui.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":2,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":"G-N6M7VZCQMD"},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  
    <!-- Google tag (gtag.js) -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=G-N6M7VZCQMD", function() {
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', 'G-N6M7VZCQMD');
        });
      }
    </script>
  

  

  

  



  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>HEX BLOG</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>Archive</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>Category</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>Tag</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>About</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="KQueue"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-03-11 14:23" pubdate>
          2023年3月11日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          1.4k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          12 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        

      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar category-bar" style="margin-right: -1rem">
    





<div class="category-list">
  
  
    
    
    
    <div class="category row nomargin-x">
      <a class="category-item 
          list-group-item category-item-action col-10 col-md-11 col-xm-11" title="网络IO"
        id="heading-8cf9a49511c5d639433ebc4cf43ab681" role="tab" data-toggle="collapse" href="#collapse-8cf9a49511c5d639433ebc4cf43ab681"
        aria-expanded="true"
      >
        网络IO
        <span class="list-group-count">(4)</span>
        <i class="iconfont icon-arrowright"></i>
      </a>
      
      <div class="category-collapse collapse show" id="collapse-8cf9a49511c5d639433ebc4cf43ab681"
           role="tabpanel" aria-labelledby="heading-8cf9a49511c5d639433ebc4cf43ab681">
        
        
          
  <div class="category-post-list">
    
    
      
      
        <a href="/2023/03/11/KQueue/" title="KQueue"
           class="list-group-item list-group-item-action
           active">
          <span class="category-post">KQueue</span>
        </a>
      
    
      
      
        <a href="/2023/03/11/Reactor/" title="Reactor"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">Reactor</span>
        </a>
      
    
      
      
        <a href="/2023/03/11/TCP/" title="TCP"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">TCP</span>
        </a>
      
    
      
      
        <a href="/2023/03/11/%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B/" title="网络模型"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">网络模型</span>
        </a>
      
    
  </div>

        
      </div>
    </div>
  
</div>


  </aside>


    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">KQueue</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="1-不使用KQueue"><a href="#1-不使用KQueue" class="headerlink" title="1 不使用KQueue"></a>1 不使用KQueue</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netinet/in.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">int</span> sfd = <span class="hljs-built_in">socket</span>(PF_INET, SOCK_STREAM, IPPROTO_TCP);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-number">-1</span> == sfd)<br>    &#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;[err] socket create: &quot;</span> &lt;&lt; errno &lt;&lt; std::endl;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-built_in">fcntl</span>(sfd, F_SETFL, O_NONBLOCK); <span class="hljs-comment">// 非阻塞</span><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">sockaddr_in</span> sock_addr;<br>    sock_addr.sin_family = PF_INET;<br>    sock_addr.sin_addr.s_addr = <span class="hljs-built_in">htonl</span>(INADDR_ANY);<br>    sock_addr.sin_port = <span class="hljs-built_in">htons</span>(<span class="hljs-number">8080</span>);<br>    <span class="hljs-type">int</span> bind_ret = <span class="hljs-built_in">bind</span>(sfd, (<span class="hljs-keyword">struct</span> sockaddr *) &amp;sock_addr, <span class="hljs-built_in">sizeof</span>(sock_addr));<br>    <span class="hljs-keyword">if</span> (<span class="hljs-number">-1</span> == bind_ret)<br>    &#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;[err] bind: &quot;</span> &lt;&lt; errno &lt;&lt; std::endl;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-number">-1</span> == (<span class="hljs-built_in">listen</span>(sfd, <span class="hljs-number">2</span>)))<br>    &#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;[err] listen: &quot;</span> &lt;&lt; errno &lt;&lt; std::endl;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-keyword">for</span> (;;)<br>    &#123;<br>        <span class="hljs-type">int</span> conn_fd = <span class="hljs-number">-1</span>;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-number">-1</span> == (conn_fd = <span class="hljs-built_in">accept</span>(sfd, (<span class="hljs-keyword">struct</span> sockaddr *) <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>)))<br>        &#123;<br>            <span class="hljs-keyword">if</span> (EWOULDBLOCK == errno) <span class="hljs-keyword">continue</span>;<br>            std::cout &lt;&lt; <span class="hljs-string">&quot;[err] accept: &quot;</span> &lt;&lt; errno &lt;&lt; std::endl;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;[succ] conn fd=&quot;</span> &lt;&lt; conn_fd &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>演示服务端拿到客户端连接的场景，在非阻塞IO下，cpu将陷于for轮询中，而且拿到连接成功socket后还需要在用户层轮询判断IO事件。</p>
<h2 id="2-使用KQueue"><a href="#2-使用KQueue" class="headerlink" title="2 使用KQueue"></a>2 使用KQueue</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netinet/in.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/event.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/time.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">int</span> sfd = <span class="hljs-built_in">socket</span>(PF_INET, SOCK_STREAM, IPPROTO_TCP);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-number">-1</span> == sfd)<br>    &#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;[err] socket create: &quot;</span> &lt;&lt; errno &lt;&lt; std::endl;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-built_in">fcntl</span>(sfd, F_SETFL, O_NONBLOCK); <span class="hljs-comment">// 非阻塞</span><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">sockaddr_in</span> sock_addr;<br>    sock_addr.sin_family = PF_INET;<br>    sock_addr.sin_addr.s_addr = <span class="hljs-built_in">htonl</span>(INADDR_ANY);<br>    sock_addr.sin_port = <span class="hljs-built_in">htons</span>(<span class="hljs-number">8080</span>);<br>    <span class="hljs-type">int</span> bind_ret = <span class="hljs-built_in">bind</span>(sfd, (<span class="hljs-keyword">struct</span> sockaddr *) &amp;sock_addr, <span class="hljs-built_in">sizeof</span>(sock_addr));<br>    <span class="hljs-keyword">if</span> (<span class="hljs-number">-1</span> == bind_ret)<br>    &#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;[err] bind: &quot;</span> &lt;&lt; errno &lt;&lt; std::endl;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-number">-1</span> == (<span class="hljs-built_in">listen</span>(sfd, <span class="hljs-number">2</span>)))<br>    &#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;[err] listen: &quot;</span> &lt;&lt; errno &lt;&lt; std::endl;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-comment">// for (;;)</span><br>    <span class="hljs-comment">// &#123;</span><br>    <span class="hljs-comment">//     int conn_fd = -1;</span><br>    <span class="hljs-comment">//     if (-1 == (conn_fd = accept(sfd, (struct sockaddr *) nullptr, nullptr)))</span><br>    <span class="hljs-comment">//     &#123;</span><br>    <span class="hljs-comment">//         if (EWOULDBLOCK == errno) continue;</span><br>    <span class="hljs-comment">//         std::cout &lt;&lt; &quot;[err] accept: &quot; &lt;&lt; errno &lt;&lt; std::endl;</span><br>    <span class="hljs-comment">//         return -1;</span><br>    <span class="hljs-comment">//     &#125;</span><br>    <span class="hljs-comment">//     std::cout &lt;&lt; &quot;[succ] conn fd=&quot; &lt;&lt; conn_fd &lt;&lt; std::endl;</span><br>    <span class="hljs-comment">// &#125;</span><br>    <span class="hljs-comment">// kqueue实例</span><br>    <span class="hljs-type">int</span> kfd = <span class="hljs-built_in">kqueue</span>();<br>    <span class="hljs-comment">// 注册事件 监听sfd连接</span><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">kevent</span> changelist[<span class="hljs-number">1</span>];<br>    <span class="hljs-built_in">EV_SET</span>(&amp;changelist[<span class="hljs-number">0</span>], sfd, EVFILT_READ, EV_ADD | EV_ENABLE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-type">int</span> register_cnt = <span class="hljs-built_in">kevent</span>(kfd, changelist, <span class="hljs-number">1</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>);<br>    <span class="hljs-comment">// kqueue监听</span><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">kevent</span> events[<span class="hljs-number">1024</span>];<br>    <span class="hljs-type">int</span> ready_cnt = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">timespec</span> timeout;<br>    timeout.tv_sec = <span class="hljs-number">3</span>;<br>    timeout.tv_nsec = <span class="hljs-number">3</span> * <span class="hljs-number">1000000</span>;<br>    <span class="hljs-keyword">for</span> (;;)<br>    &#123;<br>        <span class="hljs-keyword">if</span> ((ready_cnt = <span class="hljs-built_in">kevent</span>(kfd, <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, events, <span class="hljs-number">1024</span>, &amp;timeout)) == <span class="hljs-number">-1</span>)<br>        &#123;<br>            std::cout &lt;&lt; <span class="hljs-string">&quot;[err] kevent: &quot;</span> &lt;&lt; errno &lt;&lt; std::endl;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (ready_cnt == <span class="hljs-number">0</span>)<br>        &#123;<br>            std::cout &lt;&lt; <span class="hljs-string">&quot;没有连接&quot;</span> &lt;&lt; std::endl;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;ready_cnt=&quot;</span> &lt;&lt; ready_cnt &lt;&lt; std::endl;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; ready_cnt; ++i)<br>        &#123;<br>            std::cout &lt;&lt; <span class="hljs-string">&quot;ready_fd=&quot;</span> &lt;&lt; events[i].ident &lt;&lt; std::endl;<br>            <span class="hljs-comment">// 将连接进来的socket继续注册进复用器 关注I/O事件</span><br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="3-手册"><a href="#3-手册" class="headerlink" title="3 手册"></a>3 手册</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-built_in">KQUEUE</span>(<span class="hljs-number">2</span>)                   <span class="hljs-function">BSD System Calls Manual                  <span class="hljs-title">KQUEUE</span><span class="hljs-params">(<span class="hljs-number">2</span>)</span></span><br><span class="hljs-function"></span><br><span class="hljs-function">NNAAMMEE</span><br><span class="hljs-function">     kkqquueeuuee, kkeevveenntt, kkeevveenntt6644 <span class="hljs-keyword">and</span> kkeevveenntt__qqooss -- kernel event notification</span><br><span class="hljs-function">     mechanism</span><br><span class="hljs-function"></span><br><span class="hljs-function">LLIIBBRRAARRYY</span><br><span class="hljs-function">     Standard C <span class="hljs-title">Library</span> <span class="hljs-params">(libc, -lc)</span></span><br><span class="hljs-function"></span><br><span class="hljs-function">SSYYNNOOPPSSIISS</span><br><span class="hljs-function">     #<span class="hljs-meta">#iinncclluuddee <span class="hljs-string">&lt;&lt;ssyyss//ttyyppeess..hh&gt;</span>&gt;</span></span><br><span class="hljs-function">     #<span class="hljs-meta">#iinncclluuddee <span class="hljs-string">&lt;&lt;ssyyss//eevveenntt..hh&gt;</span>&gt;</span></span><br><span class="hljs-function">     #<span class="hljs-meta">#iinncclluuddee <span class="hljs-string">&lt;&lt;ssyyss//ttiimmee..hh&gt;</span>&gt;</span></span><br><span class="hljs-function"></span><br><span class="hljs-function">     <span class="hljs-type">_i_n_t</span></span><br><span class="hljs-function">     <span class="hljs-title">kkqquueeuuee</span><span class="hljs-params">(_v_o_i_d)</span></span>;<br><br>     <span class="hljs-function"><span class="hljs-type">_i_n_t</span></span><br><span class="hljs-function">     <span class="hljs-title">kkeevveenntt</span><span class="hljs-params">(<span class="hljs-type">_i_n_t</span> _k_q, <span class="hljs-type">_c_o_n_s_t</span> <span class="hljs-type">_s_t_r_u_c_t</span> <span class="hljs-type">_k_e_v_e_n_t</span> _*<span class="hljs-type">_c_h_a_n_g_e_l_i_s_t</span>, <span class="hljs-type">_i_n_t</span> _n_c_h_a_n_g_e_s,</span></span><br><span class="hljs-params"><span class="hljs-function">         <span class="hljs-type">_s_t_r_u_c_t</span> <span class="hljs-type">_k_e_v_e_n_t</span> _*<span class="hljs-type">_e_v_e_n_t_l_i_s_t</span>, <span class="hljs-type">_i_n_t</span> _n_e_v_e_n_t_s,</span></span><br><span class="hljs-params"><span class="hljs-function">         <span class="hljs-type">_c_o_n_s_t</span> <span class="hljs-type">_s_t_r_u_c_t</span> _t_i_m_e_s_p_e_c _*<span class="hljs-type">_t_i_m_e_o_u_t</span>)</span></span>;<br><br>     <span class="hljs-function"><span class="hljs-type">_i_n_t</span></span><br><span class="hljs-function">     <span class="hljs-title">kkeevveenntt6644</span><span class="hljs-params">(<span class="hljs-type">_i_n_t</span> _k_q, <span class="hljs-type">_c_o_n_s_t</span> <span class="hljs-type">_s_t_r_u_c_t</span> _k_e_v_e_n_t_6_4___s _*<span class="hljs-type">_c_h_a_n_g_e_l_i_s_t</span>, <span class="hljs-type">_i_n_t</span> _n_c_h_a_n_g_e_s,</span></span><br><span class="hljs-params"><span class="hljs-function">         <span class="hljs-type">_s_t_r_u_c_t</span> _k_e_v_e_n_t_6_4___s _*<span class="hljs-type">_e_v_e_n_t_l_i_s_t</span>, <span class="hljs-type">_i_n_t</span> _n_e_v_e_n_t_s, _u_n_s_i_g_n_e_d <span class="hljs-type">_i_n_t</span> _f_l_a_g_s,</span></span><br><span class="hljs-params"><span class="hljs-function">         <span class="hljs-type">_c_o_n_s_t</span> <span class="hljs-type">_s_t_r_u_c_t</span> _t_i_m_e_s_p_e_c _*<span class="hljs-type">_t_i_m_e_o_u_t</span>)</span></span>;<br><br>     <span class="hljs-function"><span class="hljs-type">_i_n_t</span></span><br><span class="hljs-function">     <span class="hljs-title">kkeevveenntt__qqooss</span><span class="hljs-params">(<span class="hljs-type">_i_n_t</span> _k_q, <span class="hljs-type">_c_o_n_s_t</span> <span class="hljs-type">_s_t_r_u_c_t</span> _k_e_v_e_n_t___q_o_s___s _*<span class="hljs-type">_c_h_a_n_g_e_l_i_s_t</span>, <span class="hljs-type">_i_n_t</span> _n_c_h_a_n_g_e_s,</span></span><br><span class="hljs-params"><span class="hljs-function">         <span class="hljs-type">_s_t_r_u_c_t</span> _k_e_v_e_n_t___q_o_s___s _*<span class="hljs-type">_e_v_e_n_t_l_i_s_t</span>, <span class="hljs-type">_i_n_t</span> _n_e_v_e_n_t_s, _v_o_i_d _*<span class="hljs-type">_d_a_t_a___o_u_t</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">         <span class="hljs-type">_s_i_z_e___t</span> _*_d_a_t_a___a_v_a_i_l_a_b_l_e, _u_n_s_i_g_n_e_d <span class="hljs-type">_i_n_t</span> _f_l_a_g_s)</span></span>;<br><br>     <span class="hljs-built_in">EEVV__SSEETT</span>(_&amp;_k_e_v, <span class="hljs-type">_i_d_e_n_t</span>, _f_i_l_t_e_r, _f_l_a_g_s, _f_f_l_a_g_s, _d_a_t_a, _u_d_a_t_a);<br><br>     <span class="hljs-built_in">EEVV__SSEETT6644</span>(_&amp;_k_e_v, <span class="hljs-type">_i_d_e_n_t</span>, _f_i_l_t_e_r, _f_l_a_g_s, _f_f_l_a_g_s, _d_a_t_a, _u_d_a_t_a, _e_x_t_[_0_],<br>         _e_x_t_[_1_]);<br><br>     <span class="hljs-built_in">EEVV__SSEETT__QQOOSS</span>(_&amp;_k_e_v, <span class="hljs-type">_i_d_e_n_t</span>, _f_i_l_t_e_r, _f_l_a_g_s, _q_o_s, _u_d_a_t_a, _f_f_l_a_g_s, _x_f_l_a_g_s, _d_a_t_a,<br>         _e_x_t_[_0_], _e_x_t_[_1_], _e_x_t_[_2_], _e_x_t_[_3_]);<br><br><span class="hljs-function">DDEESSCCRRIIPPTTIIOONN</span><br><span class="hljs-function">     The <span class="hljs-title">kkqquueeuuee</span><span class="hljs-params">()</span> system call allocates a kqueue file descriptor.  This file</span><br><span class="hljs-function">     descriptor provides a generic method of notifying the user when a kernel</span><br><span class="hljs-function">     <span class="hljs-title">event</span> <span class="hljs-params">(kevent)</span> happens <span class="hljs-keyword">or</span> a condition holds, based on the results of</span><br><span class="hljs-function">     small pieces of kernel code termed filters.</span><br><span class="hljs-function"></span><br><span class="hljs-function">     A kevent is identified by <span class="hljs-title">an</span> <span class="hljs-params">(ident, filter, <span class="hljs-keyword">and</span> optional udata value)</span></span><br><span class="hljs-function">     tuple.  It specifies the interesting conditions to be notified about <span class="hljs-keyword">for</span></span><br><span class="hljs-function">     that tuple. <span class="hljs-title">An</span> <span class="hljs-params">(ident, filter, <span class="hljs-keyword">and</span> optional udata value)</span> tuple can only</span><br><span class="hljs-function">     appear once in a given kqueue.  Subsequent attempts to <span class="hljs-keyword">register</span> the same</span><br><span class="hljs-function">     tuple <span class="hljs-keyword">for</span> a given kqueue will result in the replacement of the conditions</span><br><span class="hljs-function">     being watched, <span class="hljs-keyword">not</span> an addition.  Whether the udata value is considered as</span><br><span class="hljs-function">     part of the tuple is controlled by the EV_UDATA_SPECIFIC flag on the</span><br><span class="hljs-function">     kevent.</span><br><span class="hljs-function"></span><br><span class="hljs-function">     The filter identified in a kevent is executed upon the initial registra-</span><br><span class="hljs-function">     tion of that event in order to detect whether a preexisting condition is</span><br><span class="hljs-function">     present, <span class="hljs-keyword">and</span> is also executed whenever an event is passed to the filter</span><br><span class="hljs-function">     <span class="hljs-keyword">for</span> evaluation.  If the filter determines that the condition should be</span><br><span class="hljs-function">     reported, then the kevent is placed on the kqueue <span class="hljs-keyword">for</span> the user to</span><br><span class="hljs-function">     retrieve.</span><br><span class="hljs-function"></span><br><span class="hljs-function">     The filter is also run when the user attempts to retrieve the kevent from</span><br><span class="hljs-function">     the kqueue.  If the filter indicates that the condition that triggered</span><br><span class="hljs-function">     the event no longer holds, the kevent is removed from the kqueue <span class="hljs-keyword">and</span> is</span><br><span class="hljs-function">     <span class="hljs-keyword">not</span> returned.</span><br><span class="hljs-function"></span><br><span class="hljs-function">     Multiple events which trigger the filter <span class="hljs-keyword">do</span> <span class="hljs-keyword">not</span> result in multiple</span><br><span class="hljs-function">     kevents being placed on the kqueue</span>; instead, the filter will aggregate<br>     the events into a single <span class="hljs-keyword">struct</span> <span class="hljs-title class_">kevent</span>.  <span class="hljs-function">Calling <span class="hljs-title">cclloossee</span><span class="hljs-params">()</span> on a file</span><br><span class="hljs-function">     descriptor will remove any kevents that reference the descriptor.</span><br><span class="hljs-function"></span><br><span class="hljs-function">     The <span class="hljs-title">kkqquueeuuee</span><span class="hljs-params">()</span> system call creates a <span class="hljs-keyword">new</span> kernel event queue <span class="hljs-keyword">and</span> returns a</span><br><span class="hljs-function">     descriptor.  The queue is <span class="hljs-keyword">not</span> inherited by a child created with <span class="hljs-title">fork</span><span class="hljs-params">(<span class="hljs-number">2</span>)</span>.</span><br><span class="hljs-function"></span><br><span class="hljs-function">     The kkeevveenntt,,<span class="hljs-params">()</span> <span class="hljs-title">kkeevveenntt6644</span><span class="hljs-params">()</span> <span class="hljs-keyword">and</span> <span class="hljs-title">kkeevveenntt__qqooss</span><span class="hljs-params">()</span> system calls are used to regis-</span><br><span class="hljs-function">     ter events with the queue, <span class="hljs-keyword">and</span> <span class="hljs-keyword">return</span> any pending events to the user.</span><br><span class="hljs-function">     The <span class="hljs-type">_c_h_a_n_g_e_l_i_s_t</span> argument is a pointer to an array of _k_e_v_e_n_t_, _k_e_v_e_n_t_6_4___s <span class="hljs-keyword">or</span></span><br><span class="hljs-function">     _k_e_v_e_n_t___q_o_s___s structures, as defined in &lt;_s_y_s_/_e_v_e_n_t_._h&gt;.  All changes con-</span><br><span class="hljs-function">     tained in the <span class="hljs-type">_c_h_a_n_g_e_l_i_s_t</span> are applied before any pending events are read</span><br><span class="hljs-function">     from the queue.  The _n_c_h_a_n_g_e_s argument gives the size of <span class="hljs-type">_c_h_a_n_g_e_l_i_s_t</span>.</span><br><span class="hljs-function"></span><br><span class="hljs-function">     The <span class="hljs-type">_e_v_e_n_t_l_i_s_t</span> argument is a pointer to an array of out _k_e_v_e_n_t_, _k_e_v_e_n_t_6_4___s</span><br><span class="hljs-function">     <span class="hljs-keyword">or</span> _k_e_v_e_n_t___q_o_s___s structures.  The _n_e_v_e_n_t_s argument determines the size of</span><br><span class="hljs-function">     <span class="hljs-type">_e_v_e_n_t_l_i_s_t</span>.</span><br><span class="hljs-function"></span><br><span class="hljs-function">     The <span class="hljs-type">_d_a_t_a___o_u_t</span> argument provides space <span class="hljs-keyword">for</span> extra out data provided by spe-</span><br><span class="hljs-function">     cific filters.  The _d_a_t_a___a_v_a_i_l_a_b_l_e argument&#x27;s contents specified the</span><br><span class="hljs-function">     space available in the data pool on input, <span class="hljs-keyword">and</span> contains the amount still</span><br><span class="hljs-function">     remaining on output.  If the KEVENT_FLAG_STACK_DATA flag is specified on</span><br><span class="hljs-function">     the system call, the data is allocated from the pool in stack order</span><br><span class="hljs-function">     instead of typical heap order.</span><br><span class="hljs-function"></span><br><span class="hljs-function">     If <span class="hljs-type">_t_i_m_e_o_u_t</span> is a non-<span class="hljs-literal">NULL</span> pointer, it specifies a maximum interval to wait</span><br><span class="hljs-function">     <span class="hljs-keyword">for</span> an event, which will be interpreted as a <span class="hljs-keyword">struct</span> timespec.  If <span class="hljs-type">_t_i_m_e_o_u_t</span></span><br><span class="hljs-function">     is a <span class="hljs-literal">NULL</span> pointer, both <span class="hljs-title">kkeevveenntt</span><span class="hljs-params">()</span> <span class="hljs-keyword">and</span> <span class="hljs-title">kkeevveenntt6644</span><span class="hljs-params">()</span> wait indefinitely.  To</span><br><span class="hljs-function">     effect a poll, the _f_l_a_g_s argument to <span class="hljs-title">kkeevveenntt6644</span><span class="hljs-params">()</span> <span class="hljs-keyword">or</span> <span class="hljs-title">kkeevveenntt__qqooss</span><span class="hljs-params">()</span> can</span><br><span class="hljs-function">     include the KEVENT_FLAG_IMMEDIATE value to indicate an immediate timeout.</span><br><span class="hljs-function">     Alternatively, the <span class="hljs-type">_t_i_m_e_o_u_t</span> argument should be non-<span class="hljs-literal">NULL</span>, pointing to a</span><br><span class="hljs-function">     zero-valued _t_i_m_e_s_p_e_c structure.  The same array may be used <span class="hljs-keyword">for</span> the</span><br><span class="hljs-function">     <span class="hljs-type">_c_h_a_n_g_e_l_i_s_t</span> <span class="hljs-keyword">and</span> <span class="hljs-type">_e_v_e_n_t_l_i_s_t</span>.</span><br><span class="hljs-function"></span><br><span class="hljs-function">     The <span class="hljs-title">EEVV__SSEETT</span><span class="hljs-params">()</span> macro is provided <span class="hljs-keyword">for</span> ease of initializing a <span class="hljs-type">_k_e_v_e_n_t</span> struc-</span><br><span class="hljs-function">     ture. Similarly, <span class="hljs-title">EEVV__SSEETT6644</span><span class="hljs-params">()</span> initializes a _k_e_v_e_n_t_6_4___s structure <span class="hljs-keyword">and</span></span><br><span class="hljs-function">     <span class="hljs-title">EEVV__SSEETT__QQOOSS</span><span class="hljs-params">()</span> initializes a _k_e_v_e_n_t___q_o_s___s structure.</span><br><span class="hljs-function"></span><br><span class="hljs-function">     The _k_e_v_e_n_t_, _k_e_v_e_n_t_6_4___s <span class="hljs-keyword">and</span> _k_e_v_e_n_t___q_o_s___s structures are defined as:</span><br><span class="hljs-function"></span><br><span class="hljs-function">     struct kevent &#123;</span><br>             <span class="hljs-type">uintptr_t</span>       ident;          <span class="hljs-comment">/* identifier for this event */</span><br>             <span class="hljs-type">int16_t</span>         filter;         <span class="hljs-comment">/* filter for event */</span><br>             <span class="hljs-type">uint16_t</span>        flags;          <span class="hljs-comment">/* general flags */</span><br>             <span class="hljs-type">uint32_t</span>        fflags;         <span class="hljs-comment">/* filter-specific flags */</span><br>             <span class="hljs-type">intptr_t</span>        data;           <span class="hljs-comment">/* filter-specific data */</span><br>             <span class="hljs-type">void</span>            *udata;         <span class="hljs-comment">/* opaque user data identifier */</span><br>     &#125;;<br><br>     <span class="hljs-keyword">struct</span> <span class="hljs-title class_">kevent64_s</span> &#123;<br>             <span class="hljs-type">uint64_t</span>        ident;          <span class="hljs-comment">/* identifier for this event */</span><br>             <span class="hljs-type">int16_t</span>         filter;         <span class="hljs-comment">/* filter for event */</span><br>             <span class="hljs-type">uint16_t</span>        flags;          <span class="hljs-comment">/* general flags */</span><br>             <span class="hljs-type">uint32_t</span>        fflags;         <span class="hljs-comment">/* filter-specific flags */</span><br>             <span class="hljs-type">int64_t</span>         data;           <span class="hljs-comment">/* filter-specific data */</span><br>             <span class="hljs-type">uint64_t</span>        udata;          <span class="hljs-comment">/* opaque user data identifier */</span><br>             <span class="hljs-type">uint64_t</span>        ext[<span class="hljs-number">2</span>];         <span class="hljs-comment">/* filter-specific extensions */</span><br>     &#125;;<br><br>     <span class="hljs-keyword">struct</span> <span class="hljs-title class_">kevent_qos_s</span> &#123;<br>             <span class="hljs-type">uint64_t</span>        ident;          <span class="hljs-comment">/* identifier for this event */</span><br>             <span class="hljs-type">int16_t</span>         filter;         <span class="hljs-comment">/* filter for event */</span><br>             <span class="hljs-type">uint16_t</span>        flags;          <span class="hljs-comment">/* general flags */</span><br>             <span class="hljs-type">uint32_t</span>        qos;            <span class="hljs-comment">/* quality of service when servicing event */</span><br>             <span class="hljs-type">uint64_t</span>        udata;          <span class="hljs-comment">/* opaque user data identifier */</span><br>             <span class="hljs-type">uint32_t</span>        fflags;         <span class="hljs-comment">/* filter-specific flags */</span><br>             <span class="hljs-type">uint32_t</span>        xflags;         <span class="hljs-comment">/* extra filter-specific flags */</span><br>             <span class="hljs-type">int64_t</span>         data;           <span class="hljs-comment">/* filter-specific data */</span><br>             <span class="hljs-type">uint64_t</span>        ext[<span class="hljs-number">4</span>];         <span class="hljs-comment">/* filter-specific extensions */</span><br>     &#125;;<br><br>     ----<br><br>     The fields of <span class="hljs-type">_s_t_r_u_c_t</span> _k_e_v_e_n_t_, <span class="hljs-type">_s_t_r_u_c_t</span> _k_e_v_e_n_t_6_4___s <span class="hljs-keyword">and</span> <span class="hljs-type">_s_t_r_u_c_t</span> _k_e_v_e_n_t___q_o_s___s<br>     are:<br><br>     ident      Value used to identify the source of the event.  The exact<br>                interpretation is determined by the attached filter, but often<br>                is a file descriptor.<br><br>     filter     Identifies the kernel filter used to process <span class="hljs-keyword">this</span> event.  The<br>                pre-defined system filters are described below.<br><br>     flags      Actions to perform on the event.<br><br>     fflags     Filter-specific flags.<br><br>     data       Filter-specific data value.<br><br>     udata      Opaque user-defined value passed through the kernel unchanged.<br>                It can optionally be part of the uniquing decision of the<br>                kevent system<br><br>     In addition, <span class="hljs-type">_s_t_r_u_c_t</span> _k_e_v_e_n_t_6_4___s contains:<br><br>     ext[<span class="hljs-number">2</span>]     This field stores extensions <span class="hljs-keyword">for</span> the event<span class="hljs-number">&#x27;</span>s filter. What type<br>                of extension depends on what type of filter is being used.<br><br>     In addition, <span class="hljs-type">_s_t_r_u_c_t</span> _k_e_v_e_n_t___q_o_s___s contains:<br><br>     xflags     Extra filter-specific flags.<br><br>     ext[<span class="hljs-number">4</span>]     The QoS variant provides twice as many extension values <span class="hljs-keyword">for</span><br>                filter-specific uses.<br><br>     ----<br><br>     The _f_l_a_g_s field can contain the following values:<br><br>     EV_ADD         Adds the event to the kqueue.  Re-adding an existing event<br>                    will modify the parameters of the original event, <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span><br>                    result in a duplicate entry.  Adding an event automati-<br>                    cally enables it, unless overridden by the EV_DISABLE<br>                    flag.<br><br>     EV_ENABLE      Permit kkeevveenntt,,() <span class="hljs-built_in">kkeevveenntt6644</span>() <span class="hljs-function"><span class="hljs-keyword">and</span> <span class="hljs-title">kkeevveenntt__qqooss</span><span class="hljs-params">()</span> to <span class="hljs-keyword">return</span> the</span><br><span class="hljs-function">                    event <span class="hljs-keyword">if</span> it is triggered.</span><br><span class="hljs-function"></span><br><span class="hljs-function">     EV_DISABLE     Disable the event so kkeevveenntt,,<span class="hljs-params">()</span> <span class="hljs-title">kkeevveenntt6644</span><span class="hljs-params">()</span> <span class="hljs-keyword">and</span> <span class="hljs-title">kkeevveenntt__qqooss</span><span class="hljs-params">()</span></span><br><span class="hljs-function">                    will <span class="hljs-keyword">not</span> <span class="hljs-keyword">return</span> it.  The filter itself is <span class="hljs-keyword">not</span> disabled.</span><br><span class="hljs-function"></span><br><span class="hljs-function">     EV_DELETE      Removes the event from the kqueue.  Events which are</span><br><span class="hljs-function">                    attached to file descriptors are automatically deleted on</span><br><span class="hljs-function">                    the last close of the descriptor.</span><br><span class="hljs-function"></span><br><span class="hljs-function">     EV_RECEIPT     This flag is useful <span class="hljs-keyword">for</span> making bulk changes to a kqueue</span><br><span class="hljs-function">                    without draining any pending events. When passed as input,</span><br><span class="hljs-function">                    it forces EV_ERROR to always be returned.  When a filter</span><br><span class="hljs-function">                    is successfully added, the _d_a_t_a field will be zero.</span><br><span class="hljs-function"></span><br><span class="hljs-function">     EV_ONESHOT     Causes the event to <span class="hljs-keyword">return</span> only the first occurrence of</span><br><span class="hljs-function">                    the filter being triggered.  After the user retrieves the</span><br><span class="hljs-function">                    event from the kqueue, it is deleted.</span><br><span class="hljs-function"></span><br><span class="hljs-function">     EV_CLEAR       After the event is retrieved by the user, its state is</span><br><span class="hljs-function">                    reset.  This is useful <span class="hljs-keyword">for</span> filters which report state</span><br><span class="hljs-function">                    transitions instead of the current state.  Note that some</span><br><span class="hljs-function">                    filters may automatically set <span class="hljs-keyword">this</span> flag internally.</span><br><span class="hljs-function"></span><br><span class="hljs-function">     EV_EOF         Filters may set <span class="hljs-keyword">this</span> flag to indicate filter-specific EOF</span><br><span class="hljs-function">                    condition.</span><br><span class="hljs-function"></span><br><span class="hljs-function">     EV_OOBAND      Read filter on socket may set <span class="hljs-keyword">this</span> flag to indicate the</span><br><span class="hljs-function">                    presence of out of band data on the descriptor.</span><br><span class="hljs-function"></span><br><span class="hljs-function">     EV_ERROR       See _R_E_T_U_R_N _V_A_L_U_E_S below.</span><br><span class="hljs-function"></span><br><span class="hljs-function">     ----</span><br><span class="hljs-function"></span><br><span class="hljs-function">     The predefined system filters are listed below.  Arguments may be passed</span><br><span class="hljs-function">     to <span class="hljs-keyword">and</span> from the filter via the _d_a_t_a_, _f_f_l_a_g_s <span class="hljs-keyword">and</span> optionally _x_f_l_a_g_s fields</span><br><span class="hljs-function">     in the _k_e_v_e_n_t_, _k_e_v_e_n_t_6_4___s <span class="hljs-keyword">or</span> _k_e_v_e_n_t___q_o_s___s structure.</span><br><span class="hljs-function"></span><br><span class="hljs-function">     EVFILT_READ      Takes a file descriptor as the identifier, <span class="hljs-keyword">and</span> returns</span><br><span class="hljs-function">                      whenever there is data available to read.  The behavior</span><br><span class="hljs-function">                      of the filter is slightly different depending on the</span><br><span class="hljs-function">                      descriptor type.</span><br><span class="hljs-function"></span><br><span class="hljs-function">                      Sockets</span><br><span class="hljs-function">                          Sockets which have previously been passed to</span><br><span class="hljs-function">                          <span class="hljs-title">lliisstteenn</span><span class="hljs-params">()</span> <span class="hljs-keyword">return</span> when there is an incoming connection</span><br><span class="hljs-function">                          pending.  _d_a_t_a contains the size of the listen back-</span><br><span class="hljs-function">                          log.</span><br><span class="hljs-function"></span><br><span class="hljs-function">                          Other socket descriptors <span class="hljs-keyword">return</span> when there is data</span><br><span class="hljs-function">                          to be read, subject to the SO_RCVLOWAT value of the</span><br><span class="hljs-function">                          socket buffer.  This may be overridden with a per-</span><br><span class="hljs-function">                          filter low water mark at the time the filter is</span><br><span class="hljs-function">                          added by setting the NOTE_LOWAT flag in _f_f_l_a_g_s, <span class="hljs-keyword">and</span></span><br><span class="hljs-function">                          specifying the <span class="hljs-keyword">new</span> low water mark in _d_a_t_a.  The</span><br><span class="hljs-function">                          derived per filter low water mark value is, however,</span><br><span class="hljs-function">                          bounded by socket receive buffer&#x27;s high <span class="hljs-keyword">and</span> low</span><br><span class="hljs-function">                          water mark values.  On <span class="hljs-keyword">return</span>, _d_a_t_a contains the</span><br><span class="hljs-function">                          number of bytes of protocol data available to read.</span><br><span class="hljs-function"></span><br><span class="hljs-function">                          The presence of EV_OOBAND in _f_l_a_g_s, indicates the</span><br><span class="hljs-function">                          presence of out of band data on the socket _d_a_t_a</span><br><span class="hljs-function">                          equal to the potential number of OOB bytes availble</span><br><span class="hljs-function">                          to read.</span><br><span class="hljs-function"></span><br><span class="hljs-function">                          If the read direction of the socket has shutdown,</span><br><span class="hljs-function">                          then the filter also sets EV_EOF in _f_l_a_g_s, <span class="hljs-keyword">and</span></span><br><span class="hljs-function">                          returns the socket <span class="hljs-title">error</span> <span class="hljs-params">(<span class="hljs-keyword">if</span> any)</span> in _f_f_l_a_g_s.  It is</span><br><span class="hljs-function">                          possible <span class="hljs-keyword">for</span> EOF to be <span class="hljs-title">returned</span> <span class="hljs-params">(indicating the con-</span></span><br><span class="hljs-params"><span class="hljs-function">                          nection is gone)</span> <span class="hljs-keyword">while</span> there is still data pending</span><br><span class="hljs-function">                          in the socket buffer.</span><br><span class="hljs-function"></span><br><span class="hljs-function">                      Vnodes</span><br><span class="hljs-function">                          Returns when the file pointer is <span class="hljs-keyword">not</span> at the end of</span><br><span class="hljs-function">                          file.  _d_a_t_a contains the offset from current posi-</span><br><span class="hljs-function">                          tion to end of file, <span class="hljs-keyword">and</span> may be negative.</span><br><span class="hljs-function"></span><br><span class="hljs-function">                      Fifos, Pipes</span><br><span class="hljs-function">                          Returns when there is data to read</span>; _d_a_t_a contains<br>                          the number of bytes available.<br><br>                          When the last writer disconnects, the filter will<br>                          set EV_EOF in _f_l_a_g_s.  This may be cleared by passing<br>                          in EV_CLEAR, at which point the filter will resume<br>                          waiting <span class="hljs-keyword">for</span> data to become available before <span class="hljs-keyword">return</span>-<br>                          ing.<br><br>                      Device nodes<br>                          Returns when there is data to read from the device;<br>                          _d_a_t_a contains the number of bytes available.  If the<br>                          device does <span class="hljs-keyword">not</span> support returning number of bytes,<br>                          it will <span class="hljs-keyword">not</span> allow the filter to be attached.  How-<br>                          ever, <span class="hljs-keyword">if</span> the NOTE_LOWAT flag is specified <span class="hljs-keyword">and</span> the<br>                          _d_a_t_a field contains <span class="hljs-number">1</span> on input, those devices will<br>                          attach - but cannot be relied upon to provide an<br>                          accurate count of bytes to be read on output.<br><br>     EVFILT_EXCEPT    Takes a descriptor as the identifier, <span class="hljs-keyword">and</span> returns when-<br>                      ever one of the specified exceptional conditions has<br>                      occurred on the descriptor. Conditions are specified in<br>                      _f_f_l_a_g_s.  Currently, <span class="hljs-keyword">this</span> filter can be used to monitor<br>                      the arrival of out-of-band data on a socket descriptor<br>                      <span class="hljs-keyword">using</span> the filter flag NOTE_OOB.<br><br>                      If the read direction of the socket has shutdown, then<br>                      the filter also sets EV_EOF in _f_l_a_g_s, <span class="hljs-function"><span class="hljs-keyword">and</span> returns the</span><br><span class="hljs-function">                      socket <span class="hljs-title">error</span> <span class="hljs-params">(<span class="hljs-keyword">if</span> any)</span> in _f_f_l_a_g_s.</span><br><span class="hljs-function"></span><br><span class="hljs-function">     EVFILT_WRITE     Takes a file descriptor as the identifier, <span class="hljs-keyword">and</span> returns</span><br><span class="hljs-function">                      whenever it is possible to write to the descriptor.  For</span><br><span class="hljs-function">                      sockets, pipes <span class="hljs-keyword">and</span> fifos, _d_a_t_a will contain the amount</span><br><span class="hljs-function">                      of space remaining in the write buffer.  The filter will</span><br><span class="hljs-function">                      set EV_EOF when the reader disconnects, <span class="hljs-keyword">and</span> <span class="hljs-keyword">for</span> the fifo</span><br><span class="hljs-function">                      <span class="hljs-keyword">case</span>, <span class="hljs-keyword">this</span> may be cleared by use of EV_CLEAR.  Note that</span><br><span class="hljs-function">                      <span class="hljs-keyword">this</span> filter is <span class="hljs-keyword">not</span> supported <span class="hljs-keyword">for</span> vnodes.</span><br><span class="hljs-function"></span><br><span class="hljs-function">                      For sockets, the low water mark <span class="hljs-keyword">and</span> socket error han-</span><br><span class="hljs-function">                      dling is identical to the EVFILT_READ <span class="hljs-keyword">case</span>.</span><br><span class="hljs-function"></span><br><span class="hljs-function">     EVFILT_AIO       This filter is currently unsupported.</span><br><span class="hljs-function"></span><br><span class="hljs-function">     EVFILT_VNODE     Takes a file descriptor as the identifier <span class="hljs-keyword">and</span> the events</span><br><span class="hljs-function">                      to watch <span class="hljs-keyword">for</span> in _f_f_l_a_g_s, <span class="hljs-keyword">and</span> returns when one <span class="hljs-keyword">or</span> more of</span><br><span class="hljs-function">                      the requested events occurs on the descriptor.  The</span><br><span class="hljs-function">                      events to monitor are:</span><br><span class="hljs-function"></span><br><span class="hljs-function">                      NOTE_DELETE    The uunnlliinnkk() system call was called on</span><br><span class="hljs-function">                                     the file referenced by the descriptor.</span><br><span class="hljs-function"></span><br><span class="hljs-function">                      NOTE_WRITE     A write occurred on the file referenced</span><br><span class="hljs-function">                                     by the descriptor.</span><br><span class="hljs-function"></span><br><span class="hljs-function">                      NOTE_EXTEND    The file referenced by the descriptor was</span><br><span class="hljs-function">                                     extended.</span><br><span class="hljs-function"></span><br><span class="hljs-function">                      NOTE_ATTRIB    The file referenced by the descriptor had</span><br><span class="hljs-function">                                     its attributes changed.</span><br><span class="hljs-function"></span><br><span class="hljs-function">                      NOTE_LINK      The link count on the file changed.</span><br><span class="hljs-function"></span><br><span class="hljs-function">                      NOTE_RENAME    The file referenced by the descriptor was</span><br><span class="hljs-function">                                     renamed.</span><br><span class="hljs-function"></span><br><span class="hljs-function">                      NOTE_REVOKE    Access to the file was revoked via</span><br><span class="hljs-function">                                     revoke(<span class="hljs-number">2</span>) or the underlying fileystem was</span><br><span class="hljs-function">                                     unmounted.</span><br><span class="hljs-function"></span><br><span class="hljs-function">                      NOTE_FUNLOCK   The file was unlocked by calling flock(<span class="hljs-number">2</span>)</span><br><span class="hljs-function">                                     or close(<span class="hljs-number">2</span>)</span><br><span class="hljs-function"></span><br><span class="hljs-function">                      On return, _f_f_l_a_g_s contains the filter-specific flags</span><br><span class="hljs-function">                      which are associated with the triggered events seen by</span><br><span class="hljs-function">                      this filter.</span><br><span class="hljs-function"></span><br><span class="hljs-function">     EVFILT_PROC      Takes the process ID to monitor as the identifier and</span><br><span class="hljs-function">                      the events to watch for in _f_f_l_a_g_s, and returns when the</span><br><span class="hljs-function">                      process performs one or more of the requested events.</span><br><span class="hljs-function">                      If a process can normally see another process, it can</span><br><span class="hljs-function">                      attach an event to it.  The events to monitor are:</span><br><span class="hljs-function"></span><br><span class="hljs-function">                      NOTE_EXIT    The process has exited.</span><br><span class="hljs-function"></span><br><span class="hljs-function">                      NOTE_EXITSTATUS</span><br><span class="hljs-function">                                   The process has exited and its exit status</span><br><span class="hljs-function">                                   is in filter specific data. Valid only on</span><br><span class="hljs-function">                                   child processes and to be used along with</span><br><span class="hljs-function">                                   NOTE_EXIT.</span><br><span class="hljs-function"></span><br><span class="hljs-function">                      NOTE_FORK    The process created a child process via</span><br><span class="hljs-function">                                   fork(<span class="hljs-number">2</span>) or similar call.</span><br><span class="hljs-function"></span><br><span class="hljs-function">                      NOTE_EXEC    The process executed a new process via</span><br><span class="hljs-function">                                   execve(<span class="hljs-number">2</span>) or similar call.</span><br><span class="hljs-function"></span><br><span class="hljs-function">                      NOTE_SIGNAL  The process was sent a signal. Status can</span><br><span class="hljs-function">                                   be checked via waitpid(<span class="hljs-number">2</span>) or similar call.</span><br><span class="hljs-function"></span><br><span class="hljs-function">                      NOTE_REAP    The process was reaped by the parent via</span><br><span class="hljs-function">                                   wait(<span class="hljs-number">2</span>) or similar call. Deprecated, use</span><br><span class="hljs-function">                                   NOTE_EXIT.</span><br><span class="hljs-function"></span><br><span class="hljs-function">                      On return, _f_f_l_a_g_s contains the events which triggered</span><br><span class="hljs-function">                      the filter.</span><br><span class="hljs-function"></span><br><span class="hljs-function">     EVFILT_SIGNAL    Takes the signal number to monitor as the identifier and</span><br><span class="hljs-function">                      returns when the given signal is generated for the</span><br><span class="hljs-function">                      process.  This coexists with the ssiiggnnaall() and</span><br><span class="hljs-function">                      ssiiggaaccttiioonn() facilities, and has a lower precedence.</span><br><span class="hljs-function">                      Only signals sent to the process, not to a particular</span><br><span class="hljs-function">                      thread, will trigger the filter. The filter will record</span><br><span class="hljs-function">                      all attempts to deliver a signal to a process, even if</span><br><span class="hljs-function">                      the signal has been marked as SIG_IGN.  Event notifica-</span><br><span class="hljs-function">                      tion happens before normal signal delivery processing.</span><br><span class="hljs-function">                      _d_a_t_a returns the number of times the signal has been</span><br><span class="hljs-function">                      generated since the last call to kkeevveenntt().  This filter</span><br><span class="hljs-function">                      automatically sets the EV_CLEAR flag internally.</span><br><span class="hljs-function"></span><br><span class="hljs-function">     EVFILT_MACHPORT  Takes the name of a mach port, or port set, in _i_d_e_n_t and</span><br><span class="hljs-function">                      waits until a message is enqueued on the port or port</span><br><span class="hljs-function">                      set. When a message is detected, but not directly</span><br><span class="hljs-function">                      received by the kevent call, the name of the specific</span><br><span class="hljs-function">                      port where the message is enqueued is returned in _d_a_t_a.</span><br><span class="hljs-function">                      If _f_f_l_a_g_s contains MACH_RCV_MSG, the ext[<span class="hljs-number">0</span>] and ext[<span class="hljs-number">1</span>]</span><br><span class="hljs-function">                      flags are assumed to contain a pointer to the buffer</span><br><span class="hljs-function">                      where the message is to be received and the size of the</span><br><span class="hljs-function">                      receive buffer, respectively.  If MACH_RCV_MSG is</span><br><span class="hljs-function">                      specifed, yet the buffer size in ext[<span class="hljs-number">1</span>] is zero, The</span><br><span class="hljs-function">                      space for the buffer may be carved out of the data_out</span><br><span class="hljs-function">                      area provided to kkeevveenntt__qqooss() if there is enough space</span><br><span class="hljs-function">                      remaining there.</span><br><span class="hljs-function"></span><br><span class="hljs-function">     EVFILT_TIMER     Establishes an interval timer identified by _i_d_e_n_t where</span><br><span class="hljs-function">                      _d_a_t_a specifies the timeout period (in milliseconds).</span><br><span class="hljs-function"></span><br><span class="hljs-function">                      _f_f_l_a_g_s can include one of the following flags to specify</span><br><span class="hljs-function">                      a different unit:</span><br><span class="hljs-function"></span><br><span class="hljs-function">                      NOTE_SECONDS   _d_a_t_a is in seconds</span><br><span class="hljs-function"></span><br><span class="hljs-function">                      NOTE_USECONDS  _d_a_t_a is in microseconds</span><br><span class="hljs-function"></span><br><span class="hljs-function">                      NOTE_NSECONDS  _d_a_t_a is in nanoseconds</span><br><span class="hljs-function"></span><br><span class="hljs-function">                      NOTE_MACHTIME  _d_a_t_a is in Mach absolute time units</span><br><span class="hljs-function"></span><br><span class="hljs-function">                      _f_f_l_a_g_s can also include NOTE_ABSOLUTE, which establishes</span><br><span class="hljs-function">                      an EV_ONESHOT timer with an absolute deadline instead of</span><br><span class="hljs-function">                      an interval.  The absolute deadline is expressed in</span><br><span class="hljs-function">                      terms of gettimeofday(<span class="hljs-number">2</span>).  With NOTE_MACHTIME, the dead-</span><br><span class="hljs-function">                      line is expressed in terms of mmaacchh__aabbssoolluuttee__ttiimmee().</span><br><span class="hljs-function"></span><br><span class="hljs-function">                      The timer can be coalesced with other timers to save</span><br><span class="hljs-function">                      power. The following flags can be set in _f_f_l_a_g_s to mod-</span><br><span class="hljs-function">                      ify this behavior:</span><br><span class="hljs-function"></span><br><span class="hljs-function">                      NOTE_CRITICAL    override default power-saving tech-</span><br><span class="hljs-function">                                       niques to more strictly respect the</span><br><span class="hljs-function">                                       leeway value</span><br><span class="hljs-function"></span><br><span class="hljs-function">                      NOTE_BACKGROUND  apply more power-saving techniques to</span><br><span class="hljs-function">                                       coalesce this timer with other timers</span><br><span class="hljs-function"></span><br><span class="hljs-function">                      NOTE_LEEWAY      _e_x_t_[_1_] holds user-supplied slop in</span><br><span class="hljs-function">                                       deadline for timer coalescing.</span><br><span class="hljs-function"></span><br><span class="hljs-function">                      The timer will be periodic unless EV_ONESHOT is speci-</span><br><span class="hljs-function">                      fied.  On return, _d_a_t_a contains the number of times the</span><br><span class="hljs-function">                      timeout has expired since the last arming or last deliv-</span><br><span class="hljs-function">                      ery of the timer event.</span><br><span class="hljs-function"></span><br><span class="hljs-function">                      This filter automatically sets the EV_CLEAR flag.</span><br><span class="hljs-function"></span><br><span class="hljs-function">     ----</span><br><span class="hljs-function"></span><br><span class="hljs-function">     In the _e_x_t_[_2_] field of the _k_e_v_e_n_t_6_4___s struture, _e_x_t_[_0_] is only used with</span><br><span class="hljs-function">     the EVFILT_MACHPORT filter.  With other filters, _e_x_t_[_0_] is passed through</span><br><span class="hljs-function">     kkeevveenntt6644() much like _u_d_a_t_a.  _e_x_t_[_1_] can always be used like _u_d_a_t_a.  For</span><br><span class="hljs-function">     the use of ext[<span class="hljs-number">0</span>], see the EVFILT_MACHPORT filter above.</span><br><span class="hljs-function"></span><br><span class="hljs-function">RREETTUURRNN VVAALLUUEESS</span><br><span class="hljs-function">     The kkqquueeuuee() system call creates a new kernel event queue and returns a</span><br><span class="hljs-function">     file descriptor.  If there was an error creating the kernel event queue,</span><br><span class="hljs-function">     a value of <span class="hljs-number">-1</span> is returned and errno set.</span><br><span class="hljs-function"></span><br><span class="hljs-function">     The kkeevveenntt(), kkeevveenntt6644() and kkeevveenntt__qqooss() system calls return the number</span><br><span class="hljs-function">     of events placed in the _e_v_e_n_t_l_i_s_t, up to the value given by _n_e_v_e_n_t_s.  If</span><br><span class="hljs-function">     an error occurs while processing an element of the _c_h_a_n_g_e_l_i_s_t and there</span><br><span class="hljs-function">     is enough room in the _e_v_e_n_t_l_i_s_t, then the event will be placed in the</span><br><span class="hljs-function">     _e_v_e_n_t_l_i_s_t with EV_ERROR set in _f_l_a_g_s and the system error in _d_a_t_a.  Oth-</span><br><span class="hljs-function">     erwise, <span class="hljs-number">-1</span> will be returned, and errno will be set to indicate the error</span><br><span class="hljs-function">     condition.  If the time limit expires, then kkeevveenntt(), kkeevveenntt6644() and</span><br><span class="hljs-function">     kkeevveenntt__qqooss() return <span class="hljs-number">0.</span></span><br><span class="hljs-function"></span><br><span class="hljs-function">EERRRROORRSS</span><br><span class="hljs-function">     The kkqquueeuuee() system call fails if:</span><br><span class="hljs-function"></span><br><span class="hljs-function">     [ENOMEM]           The kernel failed to allocate enough memory for the</span><br><span class="hljs-function">                        kernel queue.</span><br><span class="hljs-function"></span><br><span class="hljs-function">     [EMFILE]           The per-process descriptor table is full.</span><br><span class="hljs-function"></span><br><span class="hljs-function">     [ENFILE]           The system file table is full.</span><br><span class="hljs-function"></span><br><span class="hljs-function">     The kkeevveenntt() and kkeevveenntt6644() system calls fail if:</span><br><span class="hljs-function"></span><br><span class="hljs-function">     [EACCES]           The process does not have permission to register a</span><br><span class="hljs-function">                        filter.</span><br><span class="hljs-function"></span><br><span class="hljs-function">     [EFAULT]           There was an error reading or writing the _k_e_v_e_n_t or</span><br><span class="hljs-function">                        _k_e_v_e_n_t_6_4___s structure.</span><br><span class="hljs-function"></span><br><span class="hljs-function">     [EBADF]            The specified descriptor is invalid.</span><br><span class="hljs-function"></span><br><span class="hljs-function">     [EINTR]            A signal was delivered before the timeout expired and</span><br><span class="hljs-function">                        before any events were placed on the kqueue for</span><br><span class="hljs-function">                        return.</span><br><span class="hljs-function"></span><br><span class="hljs-function">     [EINVAL]           The specified time limit or filter is invalid.</span><br><span class="hljs-function"></span><br><span class="hljs-function">     [ENOENT]           The event could not be found to be modified or</span><br><span class="hljs-function">                        deleted.</span><br><span class="hljs-function"></span><br><span class="hljs-function">     [ENOMEM]           No memory was available to register the event.</span><br><span class="hljs-function"></span><br><span class="hljs-function">     [ESRCH]            The specified process to attach to does not exist.</span><br><span class="hljs-function"></span><br><span class="hljs-function">SSEEEE AALLSSOO</span><br><span class="hljs-function">     aio_error(<span class="hljs-number">2</span>), aio_read(<span class="hljs-number">2</span>), aio_return(<span class="hljs-number">2</span>), read(<span class="hljs-number">2</span>), select(<span class="hljs-number">2</span>),</span><br><span class="hljs-function">     sigaction(<span class="hljs-number">2</span>), write(<span class="hljs-number">2</span>), signal(<span class="hljs-number">3</span>)</span><br><span class="hljs-function"></span><br><span class="hljs-function">HHIISSTTOORRYY</span><br><span class="hljs-function">     The kkqquueeuuee() and kkeevveenntt() system calls first appeared in FreeBSD <span class="hljs-number">4.1</span>.</span><br><span class="hljs-function"></span><br><span class="hljs-function">AAUUTTHHOORRSS</span><br><span class="hljs-function">     The kkqquueeuuee() system and this manual page were written by Jonathan Lemon</span><br><span class="hljs-function">     &lt;jlemon@FreeBSD.org&gt;.</span><br><span class="hljs-function"></span><br><span class="hljs-function">BBUUGGSS</span><br><span class="hljs-function">     Not all filesystem types support kqueue-style notifications.  And even</span><br><span class="hljs-function">     some that do, like some remote filesystems, may only support a subset of</span><br><span class="hljs-function">     the notification semantics described here.</span><br><span class="hljs-function"></span><br><span class="hljs-function">BSD                            October <span class="hljs-number">21</span>, <span class="hljs-number">2008</span>                            BSD</span><br><span class="hljs-function"></span><br></code></pre></td></tr></table></figure>

<p>重点</p>
<ul>
<li>通过kqueue()系统调用创建实例</li>
<li>EV_SET()宏创建事件数据结构kevent<ul>
<li>关注哪个fd</li>
<li>关注该fd的什么IO类型事件(可读&#x2F;可写…)</li>
<li>将该事件操作(注册&#x2F;移除&#x2F;覆盖更新…)到kqueue队列中</li>
</ul>
</li>
<li>kevent()系统调用组合实参有两个用途<ul>
<li>注册事件到kqueue中：形参changelist&#x3D;指针指向内存存放待注册事件，形参nchanges&#x3D;多少个fd事件要注册</li>
<li>复用器返回：形参eventlist&#x3D;指针指向内存存放就绪的fd，形参nevents&#x3D;存放就绪fd数量，返回值&#x3D;状态就绪的事件数量</li>
</ul>
</li>
</ul>

<div id="gitalk-container"></div>
<script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

		<script>
		var gitalkConfig = {"clientID":"7045d14418805a2028d8","clientSecret":"1631bb54c4a78f35ba07c1d35af98e8057babde9","repo":"Bannirui.github.io","owner":"Bannirui","admin":"Bannirui","distractionFreeMode":false};
	    gitalkConfig.id = md5(location.pathname);
		var gitalk = new Gitalk(gitalkConfig);
	    gitalk.render("gitalk-container");
	    </script>
                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E7%BD%91%E7%BB%9CIO/" class="category-chain-item">网络IO</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/KQueue/" class="print-no-link">#KQueue</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>KQueue</div>
      <div>https://bannirui.github.io/2023/03/11/KQueue/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>dingrui</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年3月11日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/03/11/%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B/" title="网络模型">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">网络模型</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/03/11/TCP/" title="TCP">
                        <span class="hidden-mobile">TCP</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="gitalk-container"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#gitalk-container', function() {
      Fluid.utils.createCssLink('/css/gitalk.css')
      Fluid.utils.createScript('https://lib.baomitu.com/gitalk/1.8.0/gitalk.min.js', function() {
        var options = Object.assign(
          {"clientID":"7045d14418805a2028d8","clientSecret":"1631bb54c4a78f35ba07c1d35af98e8057babde9","repo":"Bannirui.github.io","owner":"Bannirui","admin":["Bannirui"],"language":"zh-CN","labels":["Gitalk"],"perPage":10,"pagerDirection":"last","distractionFreeMode":false,"createIssueManually":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token"},
          {
            id: '53b3e3dd6de7ae36966ec868aba34ec5'
          }
        )
        var gitalk = new Gitalk(options);
        gitalk.render('gitalk-container');
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <div> <span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span> <script src="/js/duration.js"></script> </div> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    

  

</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
